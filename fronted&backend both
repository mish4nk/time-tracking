import java.time.Duration;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.time.format.DateTimeParseException;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Scanner;
import java.util.InputMismatchException;
import java.util.stream.Collectors;
    public class App {
        private static final DateTimeFormatter DATE_TIME_FORMATTER = DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm");
        private static final String DATE_FORMAT_HINT = "Format: YYYY-MM-DD HH:MM (e.g., 2025-11-25 09:00)";

        public static void main(String[] args) {
            TimeTrackingService service = new TimeTrackingService();
            Scanner scanner = new Scanner(System.in);
            String currentUserId = null;

            System.out.println("====================================");
            System.out.println(" TIME TRACKING SYSTEM (CONSOLE) ");
            System.out.println("====================================");

            while (true) {
                if (currentUserId == null) {
                    System.out.println("\n--- MAIN MENU ---");
                    System.out.println("1. Login (Enter User ID)");
                    System.out.println("2. List All Users (for quick login reference)");
                    System.out.println("3. Exit");
                    System.out.print("Choose an option: ");

                    String choice = scanner.nextLine().trim();

                    if (choice.equals("3")) {
                        System.out.println("Goodbye! System shutting down.");
                        break;
                    } else if (choice.equals("2")) {
                        service.listAllUsers();
                    } else if (choice.equals("1")) {
                        System.out.print("Enter User ID (e.g., A001, U101): ");
                        String inputId = scanner.nextLine().trim().toUpperCase();
                        User loggedInUser = service.getUser(inputId);

                        if (loggedInUser != null) {
                            currentUserId = loggedInUser.getUserId();
                            System.out.printf("✅ Logged in as: %s (%s)\n", loggedInUser.getName(), loggedInUser.getRole());
                        } else {
                            System.err.println("❌ Login Failed: Invalid User ID.");
                        }
                    } else {
                        System.err.println("Invalid option. Please try again.");
                    }
                } else {
                    User user = service.getUser(currentUserId);
                    if (user.getRole() == Role.ADMIN) {
                        handleAdminMenu(scanner, service, currentUserId);
                    } else {
                        handleUserMenu(scanner, service, currentUserId);
                    }
                    currentUserId = null; // Forces re-login/menu check after operation
                }
            }
            scanner.close();
        }

        // --- Helper for Parsing Date/Time Input ---
        private static LocalDateTime parseDateTime(Scanner scanner, String prompt) {
            LocalDateTime dateTime = null;
            while (dateTime == null) {
                System.out.printf("%s (%s): ", prompt, DATE_FORMAT_HINT);
                String input = scanner.nextLine().trim();
                try {
                    dateTime = LocalDateTime.parse(input, DATE_TIME_FORMATTER);
                } catch (DateTimeParseException e) {
                    System.err.println("❌ Invalid date/time format. Please use the required format.");
                }
            }
            return dateTime;
        }

        // --- Admin Menu Handler ---
        private static void handleAdminMenu(Scanner scanner, TimeTrackingService service, String adminId) {
            System.out.println("\n--- ADMIN DASHBOARD (ID: " + adminId + ") ---");
            System.out.println("1. Manage Users (Create/Delete/List)");
            System.out.println("2. Manage Time Logs (View/Adjust/Delete All)");
            System.out.println("3. Generate System Report (Total Hours/Productivity)");
            System.out.println("4. Configure System Settings");
            System.out.println("5. Logout");
            System.out.print("Choose an option: ");

            String choice = scanner.nextLine().trim();

            try {
                switch (choice) {
                    case "1": // User Management
                        handleAdminUserManagement(scanner, service, adminId);
                        break;
                    case "2": // Time Log Management
                        handleAdminLogManagement(scanner, service, adminId);
                        break;
                    case "3": // Report Generation
                        service.generateSystemReport(adminId);
                        break;
                    case "4": // System Configuration
                        System.out.print("Enter new Work Hours (e.g., 8:00 - 17:00): ");
                        String newWorkHours = scanner.nextLine();
                        System.out.print("Enter new Break Times (e.g., 12:00 - 13:00): ");
                        String newBreakTimes = scanner.nextLine();
                        service.configureSystem(adminId, newWorkHours, newBreakTimes);
                        break;
                    case "5":
                        System.out.println("Logged out successfully.");
                        break;
                    default:
                        System.err.println("Invalid option. Returning to Main Menu.");
                }
            } catch (Exception e) {
                System.err.println("An unexpected error occurred: " + e.getMessage());
            }
        }

        // --- Admin User Management Sub-Menu ---
        private static void handleAdminUserManagement(Scanner scanner, TimeTrackingService service, String adminId) {
            System.out.println("\n--- ADMIN: USER MANAGEMENT ---");
            System.out.println("1. List All Users");
            System.out.println("2. Create New User");
            System.out.println("3. Delete User");
            System.out.println("4. Back to Admin Dashboard");
            System.out.print("Choose an option: ");

            String choice = scanner.nextLine().trim();

            switch (choice) {
                case "1":
                    service.listAllUsers();
                    break;
                case "2":
                    System.out.print("New User ID (e.g., U104): ");
                    String newUserId = scanner.nextLine().trim().toUpperCase();
                    System.out.print("New User Name: ");
                    String newUserName = scanner.nextLine();
                    System.out.print("New User Email: ");
                    String newUserEmail = scanner.nextLine();
                    System.out.print("New User Role (ADMIN/USER): ");
                    String roleStr = scanner.nextLine().trim().toUpperCase();

                    try {
                        Role newRole = Role.valueOf(roleStr);
                        User newUser = new User(newUserId, newUserName, newUserEmail, newRole);
                        service.saveUser(adminId, newUser);
                    } catch (IllegalArgumentException e) {
                        System.err.println("❌ Invalid role entered. Must be ADMIN or USER.");
                    }
                    break;
                case "3":
                    service.listAllUsers();
                    System.out.print("Enter User ID to delete: ");
                    String deleteId = scanner.nextLine().trim().toUpperCase();
                    service.deleteUser(adminId, deleteId);
                    break;
                case "4":
                    break;
                default:
                    System.err.println("Invalid option.");
            }
        }

        // --- Admin Log Management Sub-Menu ---
        private static void handleAdminLogManagement(Scanner scanner, TimeTrackingService service, String adminId) {
            System.out.println("\n--- ADMIN: TIME LOG MANAGEMENT ---");
            System.out.println("1. View All Logs");
            System.out.println("2. Adjust (Edit) a Log");
            System.out.println("3. Delete a Log");
            System.out.println("4. Back to Admin Dashboard");
            System.out.print("Choose an option: ");

            String choice = scanner.nextLine().trim();
            int logId = -1;

            try {
                switch (choice) {
                    case "1":
                        service.listAllLogs(adminId);
                        break;
                    case "2":
                        service.listAllLogs(adminId);
                        System.out.print("Enter Log ID to adjust: ");
                        logId = Integer.parseInt(scanner.nextLine().trim());
                        TimeLog existingLog = service.getTimeLog(logId);

                        if (existingLog != null) {
                            System.out.println("Current Log Details: " + existingLog);
                            LocalDateTime newStart = parseDateTime(scanner, "Enter New Start Time");
                            LocalDateTime newEnd = parseDateTime(scanner, "Enter New End Time");
                            System.out.print("Enter New Task Description: ");
                            String newTask = scanner.nextLine();
                            service.updateTimeLog(adminId, logId, newStart, newEnd, newTask);
                        } else {
                            System.err.println("Log ID not found.");
                        }
                        break;
                    case "3":
                        service.listAllLogs(adminId);
                        System.out.print("Enter Log ID to delete: ");
                        logId = Integer.parseInt(scanner.nextLine().trim());
                        service.deleteTimeLog(adminId, logId);
                        break;
                    case "4":
                        break;
                    default:
                        System.err.println("Invalid option.");
                }
            } catch (NumberFormatException e) {
                System.err.println("❌ Invalid input. Log ID must be a number.");
            }
        }


        // --- User Menu Handler ---
        private static void handleUserMenu(Scanner scanner, TimeTrackingService service, String userId) {
            User user = service.getUser(userId);
            System.out.printf("\n--- USER DASHBOARD (%s - ID: %s) ---\n", user.getName(), userId);
            System.out.println("1. Log Work Hours");
            System.out.println("2. View My Time Logs");
            System.out.println("3. Track Productivity / Generate Personal Report");
            System.out.println("4. Logout");
            System.out.print("Choose an option: ");

            String choice = scanner.nextLine().trim();

            try {
                switch (choice) {
                    case "1": // Time Logging
                        LocalDateTime startTime = parseDateTime(scanner, "Enter Start Time");
                        LocalDateTime endTime = parseDateTime(scanner, "Enter End Time");
                        System.out.print("Enter Task Description: ");
                        String task = scanner.nextLine();
                        service.logTime(userId, startTime, endTime, task);
                        break;
                    case "2": // View Time Logs
                        service.viewPersonalTimeLogs(userId);
                        break;
                    case "3": // Productivity Tracking / Personal Report
                        service.trackProductivity(userId);
                        break;
                    case "4":
                        System.out.println("Logged out successfully.");
                        break;
                    default:
                        System.err.println("Invalid option. Returning to Main Menu.");
                }
            } catch (Exception e) {
                System.err.println("An unexpected error occurred: " + e.getMessage());
            }
        }
    }

    enum Role {
        ADMIN,
        USER
    }


    class User {
        private String userId;
        private String name;
        private String email;
        private Role role;

        public User(String userId, String name, String email, Role role) {
            this.userId = userId;
            this.name = name;
            this.email = email;
            this.role = role;
        }

        // Getters
        public String getUserId() { return userId; }
        public String getName() { return name; }
        public String getEmail() { return email; }
        public Role getRole() { return role; }

        // Setters
        public void setName(String name) { this.name = name; }
        public void setEmail(String email) { this.email = email; }
        public void setRole(Role role) { this.role = role; }

        @Override
        public String toString() {
            return String.format("ID: %s | Name: %s | Email: %s | Role: %s", userId, name, email, role);
        }
    }


    class TimeLog {
        private static int nextLogId = 1;
        private int logId;
        private String userId;
        private LocalDateTime startTime;
        private LocalDateTime endTime;
        private String taskDescription;
        private Duration duration;
        private static final DateTimeFormatter FORMATTER = DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm");

        public TimeLog(String userId, LocalDateTime startTime, LocalDateTime endTime, String taskDescription) {
            this.logId = nextLogId++;
            this.userId = userId;
            this.startTime = startTime;
            this.endTime = endTime;
            this.taskDescription = taskDescription;
            this.duration = Duration.between(startTime, endTime);
        }

        // Getters
        public int getLogId() { return logId; }
        public String getUserId() { return userId; }
        public LocalDateTime getStartTime() { return startTime; }
        public LocalDateTime getEndTime() { return endTime; }
        public String getTaskDescription() { return taskDescription; }
        public Duration getDuration() { return duration; }

        // Setters (for admin adjustments)
        public void setStartTime(LocalDateTime startTime) { this.startTime = startTime; }
        public void setEndTime(LocalDateTime endTime) {
            this.endTime = endTime;
            this.duration = Duration.between(this.startTime, endTime);
        }
        public void setTaskDescription(String taskDescription) { this.taskDescription = taskDescription; }

        @Override
        public String toString() {
            return String.format(
                    "Log %d: User %s | Task: %s | Start: %s | End: %s | Duration: %.2f hours",
                    logId, userId, taskDescription,
                    startTime.format(FORMATTER), endTime.format(FORMATTER),
                    (double) duration.toMinutes() / 60.0
            );
        }
    }


    class TimeTrackingService {
        private Map<String, User> userDb = new HashMap<>();
        private List<TimeLog> logDb = new ArrayList<>();
        private String workHours = "9:00 - 17:00";
        private String breakTimes = "12:00 - 13:00";

        public TimeTrackingService() {
            // Initialize with a default Admin and User
            User admin = new User("A001", "Admin Smith", "admin@corp.com", Role.ADMIN);
            User user1 = new User("U101", "Jane Doe", "jane@corp.com", Role.USER);
            User user2 = new User("U102", "John Wick", "john@corp.com", Role.USER);
            userDb.put(admin.getUserId(), admin);
            userDb.put(user1.getUserId(), user1);
            userDb.put(user2.getUserId(), user2);
        }

        public User getUser(String userId) {
            return userDb.get(userId);
        }

        public List<User> getAllUsers() {
            return new ArrayList<>(userDb.values());
        }

        public TimeLog getTimeLog(int logId) {
            return logDb.stream().filter(l -> l.getLogId() == logId).findFirst().orElse(null);
        }


        public void saveUser(String adminId, User user) {
            if (userDb.get(adminId) == null || userDb.get(adminId).getRole() != Role.ADMIN) {
                System.err.println("Permission Denied: Only Admins can manage users.");
                return;
            }
            userDb.put(user.getUserId(), user);
            System.out.printf("✅ Success: User %s (%s) saved.\n", user.getName(), user.getUserId());
        }


        public void deleteUser(String adminId, String userIdToDelete) {
            if (userDb.get(adminId) == null || userDb.get(adminId).getRole() != Role.ADMIN) {
                System.err.println("Permission Denied: Only Admins can manage users.");
                return;
            }
            if (userDb.remove(userIdToDelete) != null) {
                logDb.removeIf(log -> log.getUserId().equals(userIdToDelete));
                System.out.printf("✅ Success: User ID %s and all associated logs deleted.\n", userIdToDelete);
            } else {
                System.out.printf("❌ Error: User ID %s not found.\n", userIdToDelete);
            }
        }

        public void generateSystemReport(String adminId) {
            if (userDb.get(adminId) == null || userDb.get(adminId).getRole() != Role.ADMIN) {
                System.err.println("Permission Denied: Only Admins can generate system reports.");
                return;
            }

            System.out.println("\n--- DETAILED SYSTEM WORK HOURS REPORT ---");
            // Group logs by user and sum up the durations
            Map<String, Double> hoursByUser = logDb.stream()
                    .collect(Collectors.groupingBy(
                            TimeLog::getUserId,
                            Collectors.summingDouble(log -> (double) log.getDuration().toMinutes() / 60.0)
                    ));

            if (hoursByUser.isEmpty()) {
                System.out.println("No time logs have been recorded yet.");
                return;
            }

            for (Map.Entry<String, Double> entry : hoursByUser.entrySet()) {
                String userId = entry.getKey();
                String userName = userDb.getOrDefault(userId, new User(userId, "UNKNOWN", "", Role.USER)).getName();
                System.out.printf("  - %s (%s): %.2f total hours\n", userName, userId, entry.getValue());
            }

            // Productivity Trend (Simple metric: Logs per user)
            System.out.println("\n--- PRODUCTIVITY TREND (Logs Count) ---");
            Map<String, Long> logCountByUser = logDb.stream()
                    .collect(Collectors.groupingBy(TimeLog::getUserId, Collectors.counting()));

            logCountByUser.entrySet().stream()
                    .sorted(Map.Entry.<String, Long>comparingByValue().reversed())
                    .forEach(entry -> {
                        String userId = entry.getKey();
                        String userName = userDb.getOrDefault(userId, new User(userId, "UNKNOWN", "", Role.USER)).getName();
                        System.out.printf("  - %s (%s): %d logs\n", userName, userId, entry.getValue());
                    });

            System.out.println("----------------------------------------");
        }

        public void configureSystem(String adminId, String newWorkHours, String newBreakTimes) {
            if (userDb.get(adminId) == null || userDb.get(adminId).getRole() != Role.ADMIN) {
                System.err.println("Permission Denied: Only Admins can configure the system.");
                return;
            }
            this.workHours = newWorkHours;
            this.breakTimes = newBreakTimes;
            System.out.printf("✅ Success: System configuration updated. Work Hours: %s, Break Times: %s\n", workHours, breakTimes);
        }


        public void updateTimeLog(String adminId, int logId, LocalDateTime newStart, LocalDateTime newEnd, String newTask) {
            if (userDb.get(adminId) == null || userDb.get(adminId).getRole() != Role.ADMIN) {
                System.err.println("Permission Denied: Only Admins can update any time log.");
                return;
            }
            TimeLog log = logDb.stream().filter(l -> l.getLogId() == logId).findFirst().orElse(null);

            if (log != null) {
                if (newStart.isAfter(newEnd)) {
                    System.err.println("Update Failed: Start time cannot be after end time.");
                    return;
                }
                log.setStartTime(newStart);
                log.setEndTime(newEnd);
                log.setTaskDescription(newTask);
                System.out.printf("✅ Success: Log ID %d updated by Admin. New Duration: %.2f hours\n",
                        logId, (double) log.getDuration().toMinutes() / 60.0);
            } else {
                System.out.printf("❌ Error: Log ID %d not found.\n", logId);
            }
        }


        public void deleteTimeLog(String adminId, int logId) {
            if (userDb.get(adminId) == null || userDb.get(adminId).getRole() != Role.ADMIN) {
                System.err.println("Permission Denied: Only Admins can delete time logs.");
                return;
            }
            boolean removed = logDb.removeIf(log -> log.getLogId() == logId);
            if (removed) {
                System.out.printf("✅ Success: Log ID %d deleted by Admin.\n", logId);
            } else {
                System.out.printf("❌ Error: Log ID %d not found.\n", logId);
            }
        }


        public void listAllLogs(String adminId) {
            if (userDb.get(adminId) == null || userDb.get(adminId).getRole() != Role.ADMIN) {
                System.err.println("Permission Denied: Only Admins can view all time logs.");
                return;
            }
            System.out.println("\n--- ALL TIME LOGS IN SYSTEM ---");
            if (logDb.isEmpty()) {
                System.out.println("No logs recorded yet.");
            } else {
                logDb.forEach(System.out::println);
            }
            System.out.println("-------------------------------");
        }

        public void logTime(String userId, LocalDateTime start, LocalDateTime end, String taskDescription) {
            if (!userDb.containsKey(userId)) {
                System.err.println("Logging Error: User not found.");
                return;
            }
            if (start.isAfter(end)) {
                System.err.println("Logging Error: Start time cannot be after end time.");
                return;
            }

            TimeLog newLog = new TimeLog(userId, start, end, taskDescription);
            logDb.add(newLog);
            System.out.printf("✅ Success: Log ID %d recorded for %s. Duration: %.2f hours.\n",
                    newLog.getLogId(), userDb.get(userId).getName(), (double) newLog.getDuration().toMinutes() / 60.0);
        }

        public List<TimeLog> viewPersonalTimeLogs(String userId) {
            if (!userDb.containsKey(userId)) {
                System.err.println("Error: User not found.");
                return List.of();
            }

            System.out.printf("\n--- TIME LOGS for %s ---\n", userDb.get(userId).getName());
            List<TimeLog> personalLogs = logDb.stream()
                    .filter(log -> log.getUserId().equals(userId))
                    .collect(Collectors.toList());

            if (personalLogs.isEmpty()) {
                System.out.println("No logs found.");
            } else {
                personalLogs.forEach(System.out::println);
            }
            System.out.println("-------------------------------------");
            return personalLogs;
        }

        public void trackProductivity(String userId) {
            if (!userDb.containsKey(userId)) {
                System.err.println("Error: User not found.");
                return;
            }

            List<TimeLog> logs = logDb.stream()
                    .filter(log -> log.getUserId().equals(userId))
                    .collect(Collectors.toList());

            long totalMinutes = logs.stream()
                    .mapToLong(log -> log.getDuration().toMinutes())
                    .sum();

            long logCount = logs.size();
            double totalHours = (double) totalMinutes / 60.0;
            double averageLogDurationHours = logCount > 0 ? totalHours / logCount : 0.0;

            System.out.printf("\n--- PRODUCTIVITY METRICS for %s ---\n", userDb.get(userId).getName());
            System.out.printf("Total Logs Recorded: %d\n", logCount);
            System.out.printf("Total Work Hours: %.2f hours\n", totalHours);
            System.out.printf("Average Log Duration: %.2f hours\n", averageLogDurationHours);

            // Simple breakdown by task
            System.out.println("\nTask Breakdown (Hours):");
            Map<String, Double> hoursByTask = logs.stream()
                    .collect(Collectors.groupingBy(
                            TimeLog::getTaskDescription,
                            Collectors.summingDouble(log -> (double) log.getDuration().toMinutes() / 60.0)
                    ));

            hoursByTask.forEach((task, hours) ->
                    System.out.printf("  - %s: %.2f hours\n", task, hours)
            );
            System.out.println("-------------------------------------");
        }


        public void generatePersonalReport(String userId) {
            trackProductivity(userId);
        }

        public void listAllUsers() {
            System.out.println("\n--- CURRENT USERS IN SYSTEM ---");
            userDb.values().forEach(System.out::println);
            System.out.println("-------------------------------");
        }
    }
